---
title: "p8105_hw5_rl3616"
author: "Ruipeng Li"
date: "`r format(Sys.Date())`"
output: github_document
---
```{r}
library(tidyverse)
library(broom)
library(modelr)
```
## Problem 1

```{r data clean}
homicides <- read.csv("data/homicide-data.csv")

homicides_df <- homicides |> 
  janitor::clean_names() |>
  mutate(
    city_state = str_c(city, ", ", state),
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_age = str_trim(victim_age),
    victim_age = na_if(victim_age, "Unknown"),
    victim_age = parse_number(victim_age)
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
    )

```

```{r for baltimore}
baltimore_mod <- homicides_df |>
  filter(city_state == "Baltimore, MD")

baltimore_mod <- glm(
  resolved ~ victim_age + victim_sex + victim_race,
  data = homicides_df,
  family = binomial
)

broom::tidy(baltimore_mod, exponentiate = TRUE, conf.int = TRUE) |> 
  filter(term == "victim_sexMale")
```

```{r for all city}
city_results <- homicides_df |>
  group_by(city_state) |>
  nest() |>
  mutate(
    model = map(data, ~ glm(
      resolved ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial
    )),
    tidy = map(model, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))
  ) |>   #Seems I got correct result, but an unknown warning occurred.
  unnest(tidy) |>
  filter(term == "victim_sexMale") |> 
  select(-data, -model)
```  

```{r estimated ORs and CIs for each city, fig.width=8, fig.height=8, warning=FALSE}
city_results |> 
  ggplot(aes(
    x = fct_reorder(city_state, estimate),
    y = estimate
  )) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted Odds Ratios of Solved Homicides by City"
  )
```

According to the chart, most cities have odds ratios less than 1 for the “male vs female” contrast. Since female victims serve as the reference category in the model, an OR < 1 indicates that homicide cases involving male victims are less likely to be solved. In other words, cases with female victims tend to have higher odds of being solved in most cities.

## Problem 2
```{r}
library(p8105.datasets)
data("weather_df")

set.seed(123)

weather_boot <- weather_df |> 
  bootstrap(n = 5000, id = "strap_id")
```

```{r estimate}
boot_results <- weather_boot |>
  mutate(
    model  = map(strap, ~ lm(tmax ~ tmin + prcp, data = .x)),
    glnc   = map(model, glance),   # get R^2
    tidy   = map(model, tidy)      # get betas
  ) |>
  mutate(
    r_sq = map_dbl(glnc, "r.squared"),
    beta_ratio = map_dbl(tidy, ~ {
      b1 = .x |> filter(term == "tmin") |> pull(estimate)
      b2 = .x |> filter(term == "prcp") |> pull(estimate)
      b1 / b2
    })
  ) |>
  select(strap_id, r_sq, beta_ratio)

```

```{r}
boot_results |>
  pivot_longer(r_sq:beta_ratio,
               names_to = "param",
               values_to = "estimate") |>
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  facet_wrap(~ param, scales = "free_x") +
  labs(x = "Estimate", y = "Count",
       title = "Boostrap distribution of R^2 amd beta1/beta2")
  
         
         
```    

Based on the plots, both distributions exhibit varying degrees of left skew.
The skewness is more pronounced for the beta ratio, with a peak around 180 and a mean that lies to the left of the mode.
In contrast, the distribution of R^2 is closer to normal, showing only slight left skew, with a peak between 0.94 and 0.942 and a mean that is also positioned to the left of the peak.

```{r}
ci_results <- boot_results |>
  pivot_longer(r_sq:beta_ratio,
               names_to = "param",
               values_to = "estimate") |> 
  group_by(param) |> 
  summarise(
    ci_low = quantile(estimate, 0.025),
    ci_high = quantile(estimate, 0.975)
  )

ci_results
```   

As result, 95% confidence interval for $\hat{r}^2$ are (`r ci_results$ci_low[2]`, `r ci_results$ci_high[2]`);
95% confidence interval for $\frac{\hat{\beta_1}}{\hat{\beta_2}}$ are (`r ci_results$ci_low[1]`, `r ci_results$ci_high[1]`)