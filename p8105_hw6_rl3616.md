p8105_hw5_rl3616
================
Ruipeng Li
2025-12-02

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.2
    ## ✔ ggplot2   4.0.0     ✔ tibble    3.3.0
    ## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
    ## ✔ purrr     1.1.0     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(broom)
library(modelr)
```

    ## 
    ## Attaching package: 'modelr'
    ## 
    ## The following object is masked from 'package:broom':
    ## 
    ##     bootstrap

## Problem 1

``` r
homicides <- read.csv("data/homicide-data.csv")

homicides_df <- homicides |> 
  janitor::clean_names() |>
  mutate(
    city_state = str_c(city, ", ", state),
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_age = str_trim(victim_age),
    victim_age = na_if(victim_age, "Unknown"),
    victim_age = parse_number(victim_age)
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
    )
```

``` r
baltimore_mod <- homicides_df |>
  filter(city_state == "Baltimore, MD")

baltimore_mod <- glm(
  resolved ~ victim_age + victim_sex + victim_race,
  data = homicides_df,
  family = binomial
)

broom::tidy(baltimore_mod, exponentiate = TRUE, conf.int = TRUE) |> 
  filter(term == "victim_sexMale")
```

    ## # A tibble: 1 × 7
    ##   term           estimate std.error statistic  p.value conf.low conf.high
    ##   <chr>             <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
    ## 1 victim_sexMale    0.603    0.0296     -17.1 1.49e-65    0.569     0.639

``` r
city_results <- homicides_df |>
  group_by(city_state) |>
  nest() |>
  mutate(
    model = map(data, ~ glm(
      resolved ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial
    )),
    tidy = map(model, ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE))
  ) |>   #Seems I got correct result, but an unknown warning occurred.
  unnest(tidy) |>
  filter(term == "victim_sexMale") |> 
  select(-data, -model)
```

    ## Warning: There were 43 warnings in `mutate()`.
    ## The first warning was:
    ## ℹ In argument: `tidy = map(model, ~tidy(.x, exponentiate = TRUE, conf.int =
    ##   TRUE))`.
    ## ℹ In group 1: `city_state = "Albuquerque, NM"`.
    ## Caused by warning:
    ## ! glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## ℹ Run `dplyr::last_dplyr_warnings()` to see the 42 remaining warnings.

``` r
city_results |> 
  ggplot(aes(
    x = fct_reorder(city_state, estimate),
    y = estimate
  )) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted Odds Ratios of Solved Homicides by City"
  )
```

![](p8105_hw6_rl3616_files/figure-gfm/estimated%20ORs%20and%20CIs%20for%20each%20city-1.png)<!-- -->

According to the chart, most cities have odds ratios less than 1 for the
“male vs female” contrast. Since female victims serve as the reference
category in the model, an OR \< 1 indicates that homicide cases
involving male victims are less likely to be solved. In other words,
cases with female victims tend to have higher odds of being solved in
most cities.

## Problem 2

``` r
library(p8105.datasets)
data("weather_df")

set.seed(123)

weather_boot <- weather_df |> 
  bootstrap(n = 5000, id = "strap_id")
```

``` r
boot_results <- weather_boot |>
  mutate(
    model  = map(strap, ~ lm(tmax ~ tmin + prcp, data = .x)),
    glnc   = map(model, glance),   # get R^2
    tidy   = map(model, tidy)      # get betas
  ) |>
  mutate(
    r_sq = map_dbl(glnc, "r.squared"),
    beta_ratio = map_dbl(tidy, ~ {
      b1 = .x |> filter(term == "tmin") |> pull(estimate)
      b2 = .x |> filter(term == "prcp") |> pull(estimate)
      b1 / b2
    })
  ) |>
  select(strap_id, r_sq, beta_ratio)
```

``` r
boot_results |>
  pivot_longer(r_sq:beta_ratio,
               names_to = "param",
               values_to = "estimate") |>
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  facet_wrap(~ param, scales = "free_x") +
  labs(x = "Estimate", y = "Count",
       title = "Boostrap distribution of R^2 amd beta1/beta2")
```

    ## `stat_bin()` using `bins = 30`. Pick better value `binwidth`.

![](p8105_hw6_rl3616_files/figure-gfm/unnamed-chunk-3-1.png)<!-- -->

Based on the plots, both distributions exhibit varying degrees of left
skew. The skewness is more pronounced for the beta ratio, with a peak
around 180 and a mean that lies to the left of the mode. In contrast,
the distribution of R^2 is closer to normal, showing only slight left
skew, with a peak between 0.94 and 0.942 and a mean that is also
positioned to the left of the peak.

``` r
ci_results <- boot_results |>
  pivot_longer(r_sq:beta_ratio,
               names_to = "param",
               values_to = "estimate") |> 
  group_by(param) |> 
  summarise(
    ci_low = quantile(estimate, 0.025),
    ci_high = quantile(estimate, 0.975)
  )

ci_results
```

    ## # A tibble: 2 × 3
    ##   param        ci_low  ci_high
    ##   <chr>         <dbl>    <dbl>
    ## 1 beta_ratio -279.    -125.   
    ## 2 r_sq          0.934    0.947

As result, 95% confidence interval for $\hat{r}^2$ are (0.9342923,
0.9466149); 95% confidence interval for
$\frac{\hat{\beta_1}}{\hat{\beta_2}}$ are (-279.2530487, -125.2791968)

## Problem 3

``` r
birthweight_df <- read.csv("data/birthweight.csv") |> 
  janitor::clean_names() |> 
  mutate(
    babysex = ifelse(babysex == 1, "male", "female"),
    frace = recode(frace,
                   `1` = "White",
                   `2` = "Black",
                   `3` = "Asian",
                   `4` = "Puerto Rican", 
                   `8` = "Other", 
                   `9` = "Unknown"),
    mrace = recode(mrace,
                   `1` = "White",
                   `2` = "Black",
                   `3` = "Asian",
                   `4` = "Puerto Rican", 
                   `8` = "Other"),
    malform = ifelse(malform == 0, "absent", "present")
  ) |> 
  rename(
    baby_sex               = babysex,
    baby_head_circ        = bhead,
    baby_length           = blength,
    baby_weight           = bwt,
    
    mother_weight_delivery = delwt,
    family_income          = fincome,
    father_race            = frace,
    
    gestational_age        = gaweeks,
    malformation           = malform,
    
    menarche_age           = menarche,
    mother_height          = mheight,
    mother_age_delivery    = momage,
    
    mother_race            = mrace,
    parity                 = parity,
    
    prev_lowbirth_count    = pnumlbw,
    prev_small_gest_age    = pnumsga,
    
    pre_pregnancy_bmi      = ppbmi,
    mother_pre_preg_weight = ppwt,
    
    cigarettes_per_day     = smoken,
    weight_gain_pregnancy  = wtgain
  )
```

# Main model

To construct my main model, I used a data-driven approach. I started by
fitting a large model that included all variables that might reasonably
affect an infant’s birthweight. This allowed me to see which predictors
were truly meaningful and which ones contributed very little.

Based on the full model, I examined significance levels, effect sizes,
and practical relevance. Variables that appeared unimportant or had
minimal influence were removed to avoid overfitting and to make the
model easier to interpret.

After selecting the predictors that showed clearer and more consistent
effects, I built a simplified and more interpretable main model. This
refined model strikes a balance between predictive performance and
interpretability, and it serves as the foundation for comparing the
other two models in the analysis.

``` r
bw_model_main <- lm(
  baby_weight ~ 
    gestational_age +
    baby_length +
    baby_head_circ +
    mother_height +
    pre_pregnancy_bmi +
    weight_gain_pregnancy +
    cigarettes_per_day +
    baby_sex,
  data = birthweight_df
)
summary(bw_model_main)
```

    ## 
    ## Call:
    ## lm(formula = baby_weight ~ gestational_age + baby_length + baby_head_circ + 
    ##     mother_height + pre_pregnancy_bmi + weight_gain_pregnancy + 
    ##     cigarettes_per_day + baby_sex, data = birthweight_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1092.58  -180.00    -6.91   176.04  2493.01 
    ## 
    ## Coefficients:
    ##                         Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)           -6956.2860   134.1289 -51.863  < 2e-16 ***
    ## gestational_age          13.6222     1.4918   9.132  < 2e-16 ***
    ## baby_length              77.4404     2.0682  37.444  < 2e-16 ***
    ## baby_head_circ          136.6107     3.5163  38.851  < 2e-16 ***
    ## mother_height            13.9717     1.6390   8.525  < 2e-16 ***
    ## pre_pregnancy_bmi         6.4786     1.3635   4.751 2.08e-06 ***
    ## weight_gain_pregnancy     3.7245     0.4021   9.263  < 2e-16 ***
    ## cigarettes_per_day       -2.3760     0.5797  -4.099 4.23e-05 ***
    ## baby_sexmale            -29.9742     8.6844  -3.451 0.000563 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 280.2 on 4333 degrees of freedom
    ## Multiple R-squared:  0.7011, Adjusted R-squared:  0.7006 
    ## F-statistic:  1271 on 8 and 4333 DF,  p-value: < 2.2e-16

``` r
birthweight_df |> 
  add_predictions(bw_model_main) |> 
  add_residuals(bw_model_main) |> 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.2) +
  geom_hline(yintercept = 0, color = "red") +
  labs(
    title = "Residuals vs Fitted - Main Model",
    x = "Predicted Birthweight",
    y = "Residuals"
  )
```

![](p8105_hw6_rl3616_files/figure-gfm/Basic%20model%20plot-1.png)<!-- -->

The residuals in the graph are mostly randomly scattered, without any
issues of arcing or diffusion.  
The point cloud is distributed around 0, and there is no systematic
bias, which indicates that my model fits very stably and there is no
obvious heteroscedasticity problem.

``` r
bw_model_small <- lm(
  baby_weight ~ baby_length + gestational_age,
  data = birthweight_df
)
summary(bw_model_small)
```

    ## 
    ## Call:
    ## lm(formula = baby_weight ~ baby_length + gestational_age, data = birthweight_df)
    ## 
    ## Residuals:
    ##     Min      1Q  Median      3Q     Max 
    ## -1709.6  -215.4   -11.4   208.2  4188.8 
    ## 
    ## Coefficients:
    ##                  Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)     -4347.667     97.958  -44.38   <2e-16 ***
    ## baby_length       128.556      1.990   64.60   <2e-16 ***
    ## gestational_age    27.047      1.718   15.74   <2e-16 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 333.2 on 4339 degrees of freedom
    ## Multiple R-squared:  0.5769, Adjusted R-squared:  0.5767 
    ## F-statistic:  2958 on 2 and 4339 DF,  p-value: < 2.2e-16

``` r
bw_model_big <- lm(
  baby_weight ~ baby_head_circ * baby_length * baby_sex,
  data = birthweight_df
)
summary(bw_model_big)
```

    ## 
    ## Call:
    ## lm(formula = baby_weight ~ baby_head_circ * baby_length * baby_sex, 
    ##     data = birthweight_df)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -1132.99  -190.42   -10.33   178.63  2617.96 
    ## 
    ## Coefficients:
    ##                                           Estimate Std. Error t value Pr(>|t|)
    ## (Intercept)                              -801.9487  1102.3077  -0.728 0.466948
    ## baby_head_circ                            -16.5975    34.0916  -0.487 0.626388
    ## baby_length                               -21.6460    23.3720  -0.926 0.354421
    ## baby_sexmale                            -6374.8684  1677.7669  -3.800 0.000147
    ## baby_head_circ:baby_length                  3.3244     0.7126   4.666 3.17e-06
    ## baby_head_circ:baby_sexmale               198.3932    51.0917   3.883 0.000105
    ## baby_length:baby_sexmale                  123.7729    35.1185   3.524 0.000429
    ## baby_head_circ:baby_length:baby_sexmale    -3.8781     1.0566  -3.670 0.000245
    ##                                            
    ## (Intercept)                                
    ## baby_head_circ                             
    ## baby_length                                
    ## baby_sexmale                            ***
    ## baby_head_circ:baby_length              ***
    ## baby_head_circ:baby_sexmale             ***
    ## baby_length:baby_sexmale                ***
    ## baby_head_circ:baby_length:baby_sexmale ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 287.7 on 4334 degrees of freedom
    ## Multiple R-squared:  0.6849, Adjusted R-squared:  0.6844 
    ## F-statistic:  1346 on 7 and 4334 DF,  p-value: < 2.2e-16
